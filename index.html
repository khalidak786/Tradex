<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradex - Commodity Trading Platform</title>
    <style>
        /* [All previous CSS remains exactly the same] */
    </style>
</head>
<body>
    <!-- [All previous HTML content remains exactly the same until the scripts] -->

    <!-- Load Supabase JS FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Then initialize your app -->
    <script>
        // Immediately initialize Supabase when script loads
        document.supabase = supabase.createClient(
            'https://xuackwkjvjjdqjmisqlk.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1YWNrd2tqdmpqZHFqbWlzcWxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MDI5NjIsImV4cCI6MjA2NDM3ODk2Mn0.qt2VSui1WWWjmJRGbQeyqggYYIG2rYRKAO1ICHjxdzk'
        );

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM ready - initializing Tradex");
            initializeApp();
        });

        function initializeApp() {
            // Verify Supabase is initialized
            if (!document.supabase) {
                console.error("Supabase not initialized!");
                showError("System configuration error");
                return;
            }

            // Set up filters
            document.getElementById('commodity').addEventListener('change', fetchProducts);
            document.getElementById('product').addEventListener('change', fetchProducts);

            // Initial data load
            fetchProducts();

            // Set up realtime
            const channel = document.supabase
                .channel('products')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => {
                    console.log("Realtime update received");
                    fetchProducts();
                })
                .subscribe();

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                document.supabase.removeChannel(channel);
            });
        }

        async function fetchProducts() {
            const tableBody = document.getElementById('productsTableBody');
            try {
                // Show loading state
                tableBody.innerHTML = '<tr><td colspan="17" class="loading">Loading products...</td></tr>';

                // Build query
                let query = document.supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Apply filters
                const commodity = document.getElementById('commodity').value;
                const product = document.getElementById('product').value;

                if (commodity !== 'all') query = query.eq('commodity', commodity);
                if (product !== 'all') query = query.eq('product_type', product);

                // Execute query
                const { data: products, error } = await query;

                if (error) throw error;
                if (!products || products.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="17">No products found</td></tr>';
                    return;
                }

                // Render products
                tableBody.innerHTML = products.map(product => `
                    <tr>
                        <td>${product.major_group || '-'}</td>
                        <td>${product.quote_id || '-'}</td>
                        <td>${product.product_id || '-'}</td>
                        <td>${product.product_name || '-'}</td>
                        <td>${product.description || '-'}</td>
                        <td>${product.origin || '-'}</td>
                        <td>${product.quality_grade || '-'}</td>
                        <td>${product.quantity || '-'}</td>
                        <td>${product.price ? product.price.toLocaleString() : '-'}</td>
                        <td>${product.quantity && product.price ? (product.quantity * product.price).toLocaleString() : '-'}</td>
                        <td>${product.margin_required || '-'}</td>
                        <td>${product.packing || '-'}</td>
                        <td>${product.delivery_terms || '-'}</td>
                        <td>${product.payment_terms || '-'}</td>
                        <td>${product.general_tc || '-'}</td>
                        <td>${product.documents || '-'}</td>
                        <td>${product.remarks || '-'}</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error("Failed to load products:", error);
                tableBody.innerHTML = `
                    <tr><td colspan="17" class="error">
                        Error loading products: ${error.message || 'Unknown error'}
                    </td></tr>
                `;
            }
        }

        function showError(message) {
            const tableBody = document.getElementById('productsTableBody');
            tableBody.innerHTML = `
                <tr><td colspan="17" class="error">${message}</td></tr>
            `;
        }
    </script>
</body>
</html>
